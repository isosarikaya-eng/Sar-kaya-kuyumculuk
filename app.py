import sqlite3
from datetime import datetime
from typing import Dict, Optional

import pandas as pd
import streamlit as st

# ============== GENEL =================
st.set_page_config(page_title="Sarƒ±kaya Kuyumculuk", layout="wide")
NOW = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
DB = "data.db"

def db():
    return sqlite3.connect(DB, check_same_thread=False)

def run(sql, p=()):
    with db() as c:
        c.execute(sql, p); c.commit()

def q(sql, p=()):
    with db() as c:
        return pd.read_sql_query(sql, c, params=p)

# ============== ≈ûEMA ==================
def ensure_schema():
    # A√ßƒ±lƒ±≈ü bakiyeleri (HAS & TL)
    run("""CREATE TABLE IF NOT EXISTS opening_balances(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT, tl REAL DEFAULT 0.0, has REAL DEFAULT 0.0, note TEXT)""")

    # Kasa Defteri (TL & HAS hareketleri ‚Äì tahsilat/√∂deme vs.)
    run("""CREATE TABLE IF NOT EXISTS cash_ledger(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT, ttype TEXT, party TEXT,
            product TEXT, qty REAL, unit TEXT,
            unit_price REAL,           -- TL (isteƒüe baƒülƒ±)
            tl_amount REAL DEFAULT 0.0,  -- + tahsilat / - √∂deme
            has_amount REAL DEFAULT 0.0, -- + alacak / - bor√ß (HAS)
            note TEXT)""")

    # Envanter hareketleri (alƒ±≈ü/satƒ±≈ü/d√ºzeltme)
    run("""CREATE TABLE IF NOT EXISTS inventory_moves(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT, move_type TEXT, product TEXT,
            qty REAL, unit TEXT, note TEXT)""")

    # √úr√ºn maliyeti (HAS bazƒ±nda maliyet) ‚Äì tedarik kaynaƒüƒ± ile
    run("""CREATE TABLE IF NOT EXISTS product_costs(
            product TEXT PRIMARY KEY,
            has_cost_per_unit REAL NOT NULL,  -- 1 adet/gram almak i√ßin ka√ß HAS veriyorum?
            source TEXT, ts TEXT)""")

    # Envanter anƒ±ndaki kur (‚Ç∫ / 1 HAS)
    run("""CREATE TABLE IF NOT EXISTS has_rates(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT, tr_per_has REAL NOT NULL)""")

    # M√º≈üteri bor√ß/alacak (gram 24k kar≈üƒ±lƒ±ƒüƒ±)
    run("""CREATE TABLE IF NOT EXISTS customer_grams(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT, name TEXT, grams REAL,    -- + alacak, - bor√ß
            note TEXT)""")

    # Emanet altƒ±nlar (kasada devir daim eden)
    run("""CREATE TABLE IF NOT EXISTS consigned_items(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT, owner TEXT, product TEXT,
            qty REAL, unit TEXT, direction TEXT,  -- 'in' emanet giri≈ü, 'out' iade/√ßƒ±kƒ±≈ü
            note TEXT)""")

    # √ñzbaƒü net bakiye (HAS) ‚Äì tek satƒ±r
    run("""CREATE TABLE IF NOT EXISTS ozbag_balance(
            id INTEGER PRIMARY KEY CHECK(id=1),
            has_net REAL NOT NULL)""")
    if q("SELECT COUNT(*) n FROM ozbag_balance").iloc[0,0] == 0:
        run("INSERT INTO ozbag_balance(id,has_net) VALUES(1,0.0)")

ensure_schema()

# ============== √úR√úN REHBERƒ∞ =========
@st.cache_data
def catalog() -> Dict[str, dict]:
    return {
        "√áeyrek Altƒ±n":     {"unit":"adet","has_factor":0.3520},
        "Yarƒ±m Altƒ±n":      {"unit":"adet","has_factor":0.7040},
        "Tam Altƒ±n":        {"unit":"adet","has_factor":1.4080},
        "Ata Lira":         {"unit":"adet","has_factor":1.4160},
        "24 Ayar Gram":     {"unit":"gr",  "has_factor":1.0000},
        "22 Ayar Gram":     {"unit":"gr",  "has_factor":0.9160},
        "22 Ayar 0,5 gr":   {"unit":"adet","has_factor":0.4580},
        "22 Ayar 0,25 gr":  {"unit":"adet","has_factor":0.2290},
        "Hurda Bilezik 22K":{"unit":"gr",  "has_factor":0.9160},  # varsayƒ±lan mil
    }
CAT = catalog()
PRODUCTS = list(CAT.keys())

def has_equiv(product:str, qty:float)->float:
    return round(qty * CAT[product]["has_factor"], 6)

def latest_has_rate()->Optional[float]:
    df = q("SELECT tr_per_has FROM has_rates ORDER BY id DESC LIMIT 1")
    return float(df.iloc[0,0]) if not df.empty else None

def get_cost(product:str)->Optional[float]:
    df = q("SELECT has_cost_per_unit FROM product_costs WHERE product=?",(product,))
    return float(df.iloc[0,0]) if not df.empty else None

# ============== √úST MEN√ú =============
st.title("üíé Sarƒ±kaya Kuyumculuk ‚Äî Kasa ‚Ä¢ Envanter ‚Ä¢ Maliyet")

tabs = st.tabs([
    "üì¶ A√ßƒ±lƒ±≈ü & √ñzet",
    "üßæ ƒ∞≈ülemler (Alƒ±≈ü/Satƒ±≈ü/√ñdeme/Tahsilat)",
    "üè∑Ô∏è Maliyet & Kur",
    "üìã Envanter Sayƒ±mƒ±",
    "üè¶ √ñzbaƒü & Emanet",
])

# ---------- 1) A√ßƒ±lƒ±≈ü & √ñzet ----------
with tabs[0]:
    st.subheader("A√ßƒ±lƒ±≈ü Bakiyeleri")
    col_a, col_b, col_c = st.columns([1,1,2])
    with col_a:
        tl_open = st.number_input("A√ßƒ±lƒ±≈ü TL", min_value=0.0, step=100.0, key="open_tl")
    with col_b:
        has_open = st.number_input("A√ßƒ±lƒ±≈ü HAS", min_value=0.0, step=1.0, key="open_has")
    with col_c:
        note_open = st.text_input("Not", key="open_note")
    if st.button("A√ßƒ±lƒ±≈ü kaydet", key="btn_open"):
        run("INSERT INTO opening_balances(ts,tl,has,note) VALUES(?,?,?,?)",
            (NOW, tl_open, has_open, note_open))
        st.success("A√ßƒ±lƒ±≈ü g√ºncellendi.")

    st.markdown("### Toplam Bakiyeler")
    tl0, has0 = 0.0, 0.0
    df_open = q("SELECT tl,has FROM opening_balances")
    if not df_open.empty:
        tl0 = float(df_open["tl"].sum())
        has0 = float(df_open["has"].sum())

    df_cash = q("SELECT tl_amount,has_amount FROM cash_ledger")
    tl_sum = float(df_cash["tl_amount"].sum()) if not df_cash.empty else 0.0
    has_sum = float(df_cash["has_amount"].sum()) if not df_cash.empty else 0.0

    # √ñzbaƒü net pozisyonu
    ozbag = q("SELECT has_net FROM ozbag_balance").iloc[0,0]

    c1,c2,c3 = st.columns(3)
    c1.metric("Kasa TL", f"{tl0 + tl_sum:,.2f} ‚Ç∫")
    c2.metric("Kasa HAS", f"{has0 + has_sum:,.3f} HAS")
    c3.metric("√ñzbaƒü Net (HAS)", f"{ozbag:,.3f} HAS")

    st.caption("Not: √ñzbaƒü Net (+) = √ñzbaƒü size bor√ßlu, (-) = sizin √ñzbaƒü'a borcunuz.")

# ---------- 2) ƒ∞≈ülemler ----------
with tabs[1]:
    st.subheader("ƒ∞≈ülem Giri≈üi")
    tcol1,tcol2,tcol3 = st.columns(3)
    with tcol1:
        ttype = st.selectbox("T√ºr", [
            "alƒ±≈ü (m√º≈üteriden)", "satƒ±≈ü (m√º≈üteriye)",
            "tahsilat (TL)", "√∂deme (TL)",
            "m√º≈üteri not (gram)", "envanter d√ºzeltme"
        ], key="tr_type")
    with tcol2:
        product = st.selectbox("√úr√ºn", PRODUCTS, key="tr_product")
    with tcol3:
        qty = st.number_input("Adet / Gram", min_value=0.0, step=1.0, key="tr_qty")

    ucol1, ucol2, ucol3 = st.columns(3)
    with ucol1:
        unit = CAT[product]["unit"]
        st.text_input("Birim", value=unit, disabled=True, key="tr_unit_ro")
    with ucol2:
        unit_price = st.number_input("Birim Fiyat (TL) (opsiyonel)", min_value=0.0, step=1.0, key="tr_uprice")
    with ucol3:
        party = st.text_input("M√º≈üteri/Taraf (ops.)", key="tr_party")

    note = st.text_input("Not", key="tr_note")

    if st.button("Kaydet", key="btn_tr_save"):
        has_mov = 0.0
        tl_mov = 0.0
        move_type = None

        if ttype == "alƒ±≈ü (m√º≈üteriden)":
            move_type = "purchase"
            # m√º≈üteriden √ºr√ºn aldƒ±k ‚Üí stok +, TL - (istersek); HAS defteri: - (m√º≈üteriye bor√ßlanma yoksa 0)
            # burada sade: envantere giri≈ü
            run("""INSERT INTO inventory_moves(ts,move_type,product,qty,unit,note)
                   VALUES(?,?,?,?,?,?)""",(NOW,move_type,product,qty,unit,note))
            # TL √∂deme giri≈üi (negatif kasa)
            if unit_price>0:
                tl_mov = -(qty*unit_price)
            run("""INSERT INTO cash_ledger(ts,ttype,party,product,qty,unit,unit_price,tl_amount,has_amount,note)
                   VALUES(?,?,?,?,?,?,?,?,?,?)""",
                (NOW,"purchase",party,product,qty,unit,unit_price,tl_mov,0.0,note))

        elif ttype == "satƒ±≈ü (m√º≈üteriye)":
            move_type = "sale"
            run("""INSERT INTO inventory_moves(ts,move_type,product,qty,unit,note)
                   VALUES(?,?,?,?,?,?)""",(NOW,move_type,product,-qty,unit,note))
            if unit_price>0:
                tl_mov = +(qty*unit_price)
            run("""INSERT INTO cash_ledger(ts,ttype,party,product,qty,unit,unit_price,tl_amount,has_amount,note)
                   VALUES(?,?,?,?,?,?,?,?,?,?)""",
                (NOW,"sale",party,product,qty,unit,unit_price,tl_mov,0.0,note))

        elif ttype == "tahsilat (TL)":
            tl_mov = +qty
            run("""INSERT INTO cash_ledger(ts,ttype,party,tl_amount,note)
                   VALUES(?,?,?,?,?)""",(NOW,"collection",party,tl_mov,note))

        elif ttype == "√∂deme (TL)":
            tl_mov = -qty
            run("""INSERT INTO cash_ledger(ts,ttype,party,tl_amount,note)
                   VALUES(?,?,?,?,?)""",(NOW,"payment",party,tl_mov,note))

        elif ttype == "m√º≈üteri not (gram)":
            # +grams = m√º≈üteriden ALACAK, -grams = m√º≈üteriye BOR√á
            run("""INSERT INTO customer_grams(ts,name,grams,note)
                   VALUES(?,?,?,?)""", (NOW, party or "-", qty, note))

        elif ttype == "envanter d√ºzeltme":
            move_type = "adjust"
            run("""INSERT INTO inventory_moves(ts,move_type,product,qty,unit,note)
                   VALUES(?,?,?,?,?,?)""",(NOW,move_type,product,qty,unit,note))

        st.success("ƒ∞≈ülem kaydedildi.")

    st.markdown("#### Son ƒ∞≈ülemler")
    st.dataframe(q("""SELECT ts, ttype, party, product, qty, unit, unit_price, tl_amount, has_amount, note
                      FROM cash_ledger ORDER BY id DESC LIMIT 50"""),
                 use_container_width=True)

# ---------- 3) Maliyet & Kur ----------
with tabs[2]:
    st.subheader("√úr√ºn Maliyeti (HAS) & Envanter Kuru")
    st.caption("√áeyrek gibi √ºr√ºnlerde **1 adet almak i√ßin ka√ß HAS** verdiƒüinizi girin. Kaynak: √ñzbaƒü veya manuel.")

    c1,c2,c3 = st.columns(3)
    with c1:
        p_sel = st.selectbox("√úr√ºn se√ß", PRODUCTS, key="cost_p")
    with c2:
        d_cur = get_cost(p_sel) or has_equiv(p_sel,1.0)  # yoksa default HAS i√ßeriƒüine e≈üitle
        cost_has = st.number_input("1 birim i√ßin HAS maliyeti", min_value=0.0, value=float(d_cur), step=0.001, key="cost_val")
    with c3:
        src = st.selectbox("Kaynak", ["√ñzbaƒü","Manuel"], key="cost_src")
    if st.button("Maliyeti Kaydet", key="cost_save"):
        run("""INSERT INTO product_costs(product,has_cost_per_unit,source,ts)
               VALUES(?,?,?,?)
               ON CONFLICT(product) DO UPDATE SET has_cost_per_unit=excluded.has_cost_per_unit,
                                                 source=excluded.source, ts=excluded.ts""",
            (p_sel, cost_has, src, NOW))
        st.success("Maliyet g√ºncellendi.")

    st.markdown("##### Tanƒ±mlƒ± Maliyetler")
    st.dataframe(q("SELECT product, has_cost_per_unit, source, ts FROM product_costs ORDER BY product"),
                 use_container_width=True)

    st.divider()
    hr = latest_has_rate() or 0.0
    new_rate = st.number_input("HAS kuru (‚Ç∫ / 1 HAS)", min_value=0.0, value=float(hr), step=1.0, key="has_rate")
    if st.button("Kuru Kaydet", key="rate_save"):
        run("INSERT INTO has_rates(ts,tr_per_has) VALUES(?,?)", (NOW, new_rate))
        st.success("HAS kuru kaydedildi.")

# ---------- 4) Envanter Sayƒ±mƒ± ----------
with tabs[3]:
    st.subheader("G√ºnl√ºk Envanter Sayƒ±mƒ± & Deƒüerleme")
    rate = latest_has_rate()
    if not rate:
        st.warning("√ñnce **Maliyet & Kur** sekmesinden bir **HAS kuru** girin.")
    else:
        st.info(f"Kullanƒ±lan HAS kuru: **{rate:,.2f} ‚Ç∫**")

    st.caption("Her √ºr√ºn i√ßin saydƒ±ƒüƒ±nƒ±z miktarƒ± girin; deƒüerleme √ºr√ºne tanƒ±mlƒ± **HAS maliyeti** ve g√ºncel kurla yapƒ±lƒ±r.")

    rows = []
    total_has_cost = 0.0
    total_tl_cost = 0.0
    for p in PRODUCTS:
        cols = st.columns([3,2,2,2,2], vertical_alignment="center")
        qty_count = cols[0].number_input(f"{p} sayƒ±m", min_value=0.0, step=1.0, key=f"inv_qty_{p}")
        unit = CAT[p]["unit"]
        cols[1].text_input("Birim", value=unit, disabled=True, key=f"inv_unit_{p}")
        # √ºr√ºn maliyeti (HAS)
        p_cost = get_cost(p) or has_equiv(p,1.0)
        cols[2].number_input("HAS maliyeti/birim", min_value=0.0, value=float(p_cost), step=0.001, key=f"inv_cost_{p}", disabled=True)
        has_val = qty_count * p_cost
        tl_val = has_val * (rate or 0.0)
        cols[3].text_input("HAS toplam", value=f"{has_val:,.3f}", disabled=True, key=f"inv_has_{p}")
        cols[4].text_input("TL toplam", value=f"{tl_val:,.2f}", disabled=True, key=f"inv_tl_{p}")

        rows.append((p, qty_count, unit, p_cost, has_val, tl_val))
        total_has_cost += has_val
        total_tl_cost += tl_val

    st.divider()
    st.metric("Toplam HAS (maliyet)", f"{total_has_cost:,.3f} HAS")
    st.metric("Toplam TL (maliyet)", f"{total_tl_cost:,.2f} ‚Ç∫")
    st.caption("Not: Bu ekran **sayƒ±m fotoƒürafƒ±** gibidir; isterseniz ayrƒ±ca d√ºzeltme hareketi olarak kaydedebilirsiniz.")

# ---------- 5) √ñzbaƒü & Emanet ----------
with tabs[4]:
    st.subheader("√ñzbaƒü ƒ∞≈ülemleri (Hurda Bilezik Alƒ±mƒ± / Mahsup)")
    oc1, oc2 = st.columns(2)

    with oc1:
        st.markdown("##### Hurda Bilezik 22K **Alƒ±m** (√ñzbaƒü‚Äôa g√∂nderilecek)")
        hb_qty = st.number_input("Miktar (gr)", min_value=0.0, step=1.0, key="hb_qty")
        hb_note = st.text_input("Not", key="hb_note")
        if st.button("Hurda Bilezik Al / Stoka Ekle", key="hb_btn"):
            # Envantere +, Kasa hareketi yok (mahsup i√ßin ayrƒ±)
            run("""INSERT INTO inventory_moves(ts,move_type,product,qty,unit,note)
                   VALUES(?,?,?,?,?,?)""", (NOW,"scrap_in","Hurda Bilezik 22K",hb_qty,"gr",hb_note))
            st.success("Hurda bilezik envantere alƒ±ndƒ±.")

    with oc2:
        st.markdown("##### √ñzbaƒü **Mahsup** (hurda g√∂nder ‚Üí √ºr√ºn al / bor√ß kapat)")
        mcol1, mcol2 = st.columns(2)
        with mcol1:
            get_prod = st.selectbox("Aldƒ±ƒüƒ±n √ºr√ºn", PRODUCTS, index=PRODUCTS.index("√áeyrek Altƒ±n"), key="oz_get_p")
            get_qty  = st.number_input("Aldƒ±ƒüƒ±n miktar", min_value=0.0, step=1.0, key="oz_get_q")
        with mcol2:
            give_scrap = st.number_input("G√∂nderilen Hurda (gr)", min_value=0.0, step=1.0, key="oz_give_scrap")
            oz_note = st.text_input("Not", key="oz_note")

        if st.button("Mahsup Yap", key="oz_settle"):
            # 1) hurda √ßƒ±kƒ±≈üƒ± (envanter -)
            run("""INSERT INTO inventory_moves(ts,move_type,product,qty,unit,note)
                   VALUES(?,?,?,?,?,?)""", (NOW,"supplier_out","Hurda Bilezik 22K",-give_scrap,"gr",oz_note))
            # 2) √ºr√ºn giri≈üi (envanter +)
            run("""INSERT INTO inventory_moves(ts,move_type,product,qty,unit,note)
                   VALUES(?,?,?,?,?,?)""", (NOW,"supplier_in",get_prod,get_qty,CAT[get_prod]["unit"],oz_note))
            # 3) √ñzbaƒü net HAS g√ºncelle (g√∂nderilen hurdanƒ±n HAS kar≈üƒ±lƒ±ƒüƒ± -; alƒ±nan √ºr√ºn√ºn tedarik HAS maliyeti +)
            scrap_has = give_scrap * CAT["Hurda Bilezik 22K"]["has_factor"]
            prod_has_cost = get_cost(get_prod) or has_equiv(get_prod,1.0)
            delta = prod_has_cost*get_qty - scrap_has  # (+) √ñzbaƒü bize bor√ßlu, (-) biz √ñzbaƒü'a
            cur = q("SELECT has_net FROM ozbag_balance").iloc[0,0]
            run("UPDATE ozbag_balance SET has_net=?", (cur + delta,))
            st.success(f"Mahsup tamam: √ñzbaƒü net deƒüi≈üim {delta:+.3f} HAS")

    st.divider()
    st.subheader("Emanet (Kasada devir daim eden)")
    e1, e2, e3, e4 = st.columns(4)
    with e1:
        em_owner = st.text_input("ƒ∞sim Soyisim", key="em_name")
    with e2:
        em_product = st.selectbox("√úr√ºn", PRODUCTS, key="em_prod")
    with e3:
        em_qty = st.number_input("Adet/Gram", min_value=0.0, step=1.0, key="em_qty")
    with e4:
        em_dir = st.selectbox("Y√∂n", ["in (emanet alƒ±ndƒ±)","out (emanet iade)"], key="em_dir")
    em_note = st.text_input("Not", key="em_note")
    if st.button("Emanet Kaydet", key="em_save"):
        direction = "in" if em_dir.startswith("in") else "out"
        run("""INSERT INTO consigned_items(ts,owner,product,qty,unit,direction,note)
               VALUES(?,?,?,?,?,?,?)""",
            (NOW,em_owner,em_product,em_qty,CAT[em_product]["unit"],direction,em_note))
        st.success("Emanet hareketi kaydedildi.")

    st.markdown("##### Emanet √ñzeti")
    df_em = q("""SELECT owner, product,
                        SUM(CASE WHEN direction='in'  THEN qty ELSE 0 END) AS giren,
                        SUM(CASE WHEN direction='out' THEN qty ELSE 0 END) AS cikan,
                        SUM(CASE WHEN direction='in'  THEN qty ELSE 0 END)
                      - SUM(CASE WHEN direction='out' THEN qty ELSE 0 END) AS bakiye,
                        MAX(ts) AS son_hareket
                 FROM consigned_items
                 GROUP BY owner, product
                 ORDER BY owner, product""")
    st.dataframe(df_em, use_container_width=True)

    st.divider()
    st.subheader("M√º≈üteri Bor√ß / Alacak (Gram 24k kar≈üƒ±lƒ±ƒüƒ±)")
    cna, cng = st.columns(2)
    with cna:
        cust = st.text_input("ƒ∞sim Soyisim", key="cg_name")
    with cng:
        grams = st.number_input("Gram (+ alacak, - bor√ß)", step=0.001, key="cg_grams")
    cg_note = st.text_input("Not", key="cg_note")
    if st.button("Bor√ß/Alacak Kaydet", key="cg_save"):
        run("INSERT INTO customer_grams(ts,name,grams,note) VALUES(?,?,?,?)", (NOW,cust,grams,cg_note))
        st.success("Kayƒ±t eklendi.")
    st.markdown("##### √ñzet")
    st.dataframe(q("""SELECT name, SUM(grams) AS net_grams
                      FROM customer_grams GROUP BY name ORDER BY name"""),
                 use_container_width=True)